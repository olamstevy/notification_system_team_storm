graph TB
    %% Clients
    Client[("ğŸŒ Clients<br/>(Web/Mobile/API)")]
    
    %% API Gateway
    Client -->|HTTP POST| Gateway["ğŸ”· API Gateway Service<br/>Port: 3000<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>âœ“ Authentication<br/>âœ“ Validation<br/>âœ“ Idempotency Check<br/>âœ“ Status Tracking"]
    
    %% API Gateway to other services
    Gateway -->|REST: Validate User| UserService["ğŸ”· User Service<br/>Port: 3001<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ User Management<br/>â€¢ Preferences<br/>â€¢ Push Tokens<br/>â€¢ JWT Auth"]
    
    Gateway -->|REST: Get Template| TemplateService["ğŸ”· Template Service<br/>Port: 3002<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Template Storage<br/>â€¢ Variable Substitution<br/>â€¢ Multi-language<br/>â€¢ Version History"]
    
    Gateway -->|Publish Message| RabbitMQ["ğŸŸ  RabbitMQ Message Broker<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Exchange: notifications.direct<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"]
    
    %% RabbitMQ Queues
    RabbitMQ -->|Route: email| EmailQueue["ğŸ“§ email.queue<br/>(Durable)"]
    RabbitMQ -->|Route: push| PushQueue["ğŸ“± push.queue<br/>(Durable)"]
    RabbitMQ -.->|Failed Messages| DLQ["âš ï¸ failed.queue<br/>(Dead Letter Queue)"]
    
    %% Worker Services
    EmailQueue -->|Consume| EmailService["ğŸŸ¢ Email Service<br/>Port: 3003<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â—† Circuit Breaker<br/>â†» Retry System<br/>â€¢ Max 5 attempts<br/>â€¢ Exponential backoff<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Sends via: SMTP"]
    
    PushQueue -->|Consume| PushService["ğŸŸ¢ Push Service<br/>Port: 3004<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â—† Circuit Breaker<br/>â†» Retry System<br/>â€¢ Max 5 attempts<br/>â€¢ Exponential backoff<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Sends via: FCM"]
    
    %% Worker services call other services
    EmailService -->|Get User Data| UserService
    EmailService -->|Render Template| TemplateService
    EmailService -->|Update Status| Gateway
    
    PushService -->|Get User Data| UserService
    PushService -->|Render Template| TemplateService
    PushService -->|Update Status| Gateway
    
    %% External Services
    EmailService -->|SMTP| SMTP["ğŸ“® SMTP Server<br/>(Gmail/SendGrid)"]
    PushService -->|FCM API| FCM["ğŸ”” FCM Server<br/>(Firebase)"]
    
    %% Failure handling
    EmailService -.->|After 5 retries| DLQ
    PushService -.->|After 5 retries| DLQ
    
    %% Databases
    Gateway -->|Read/Write| GatewayDB[("ğŸ—„ï¸ PostgreSQL<br/>api_gateway_db")]
    UserService -->|Read/Write| UserDB[("ğŸ—„ï¸ PostgreSQL<br/>user_service_db")]
    TemplateService -->|Read/Write| TemplateDB[("ğŸ—„ï¸ PostgreSQL<br/>template_service_db")]
    
    %% Redis Cache
    UserService -->|Cache| Redis[("ğŸ’¾ Redis Cache<br/>Port: 6379<br/>â”â”â”â”â”â”â”â”â”â”<br/>â€¢ User preferences<br/>â€¢ Rate limiting<br/>â€¢ Session cache")]
    Gateway -->|Cache| Redis
    
    %% Styling
    classDef apiGateway fill:#007bff,stroke:#0056b3,stroke-width:3px,color:#fff
    classDef services fill:#007bff,stroke:#0056b3,stroke-width:2px,color:#fff
    classDef workers fill:#28a745,stroke:#1e7e34,stroke-width:2px,color:#fff
    classDef queue fill:#fd7e14,stroke:#dc6502,stroke-width:2px,color:#fff
    classDef database fill:#6f42c1,stroke:#4e2a84,stroke-width:2px,color:#fff
    classDef external fill:#6c757d,stroke:#495057,stroke-width:2px,color:#fff
    classDef dlq fill:#dc3545,stroke:#a71d2a,stroke-width:2px,color:#fff
    classDef cache fill:#17a2b8,stroke:#117a8b,stroke-width:2px,color:#fff
    
    class Gateway apiGateway
    class UserService,TemplateService services
    class EmailService,PushService workers
    class RabbitMQ,EmailQueue,PushQueue queue
    class GatewayDB,UserDB,TemplateDB database
    class SMTP,FCM external
    class DLQ dlq
    class Redis cache
